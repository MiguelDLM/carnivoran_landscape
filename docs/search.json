[
  {
    "objectID": "chatar_data.html",
    "href": "chatar_data.html",
    "title": "Carnivoran jaws available",
    "section": "",
    "text": "Code\n#load RData\nload(\"PBDB_carnivora_env.RData\")\n\n\n\nInteractive Sunburst Chart\n\n\nCode\n# Interactive sunburst chart (3-level): Root &gt; Family &gt; Availability &gt; Extant Status\nlibrary(plotly)\nlibrary(dplyr)\nlibrary(tibble)\nlibrary(htmltools)\n\n# Prepare data for sunburst: ensure we have the columns and clean values\nmandibles_dataset &lt;- mandibles_dataset %&gt;%\n  mutate(\n    family = ifelse(!is.null(family.y) & !is.na(family.y) & family.y != \"\", as.character(family.y), \"Unknown\"),\n    availability = ifelse(is.na(availability) | availability == \"\", \"No Data\", \n                         ifelse(availability == \"Chatar\", \"Chatar\", \"No Data\")),\n    is_extant = ifelse(is.na(is_extant) | is_extant == \"\", \"Unknown\", as.character(is_extant))\n  )\n\n# Build hierarchical data structure for sunburst\n# Level 1: Root (center)\n# Level 2: Families \n# Level 3: Availability within families\n# Level 4: Extant status within availability\n\n# Count species at each level\nspecies_counts &lt;- mandibles_dataset %&gt;%\n  group_by(family, availability, is_extant) %&gt;%\n  summarise(n_species = n_distinct(accepted_name), .groups = \"drop\") %&gt;%\n  filter(n_species &gt; 0)\n\n# Create sunburst data structure\n## Build sunburst nodes with unique ids to avoid collisions\nsafe_id &lt;- function(x) gsub(\"[^A-Za-z0-9_:-]\", \"_\", x)\n\nsunburst_data &lt;- tibble(ids=character(), labels=character(), parents=character(), values=numeric(), colors=character())\n\n# Root node\nsunburst_data &lt;- sunburst_data %&gt;% add_row(ids = \"root::Carnivora\", labels = \"Carnivora\", parents = \"\", values = sum(species_counts$n_species), colors = \"#CCCCCC\")\n\n# Family nodes\nfamily_data &lt;- species_counts %&gt;% group_by(family) %&gt;% summarise(total_species = sum(n_species), .groups = \"drop\") %&gt;% arrange(desc(total_species))\nfor(i in seq_len(nrow(family_data))) {\n  fam &lt;- family_data$family[i]\n  fam_id &lt;- paste0(\"fam::\", safe_id(fam))\n  total_sp &lt;- family_data$total_species[i]\n  sunburst_data &lt;- sunburst_data %&gt;% add_row(ids = fam_id, labels = paste0(fam, \"&lt;br&gt;(\", total_sp, \" spp)\"), parents = \"root::Carnivora\", values = total_sp, colors = \"#888888\")\n}\n\n# Availability nodes\navail_data &lt;- species_counts %&gt;% group_by(family, availability) %&gt;% summarise(total_species = sum(n_species), .groups = \"drop\")\nfor(i in seq_len(nrow(avail_data))) {\n  fam &lt;- avail_data$family[i]\n  fam_id &lt;- paste0(\"fam::\", safe_id(fam))\n  avail &lt;- avail_data$availability[i]\n  avail_id &lt;- paste0(fam_id, \"::avail::\", safe_id(avail))\n  total_sp &lt;- avail_data$total_species[i]\n  color &lt;- ifelse(avail == \"Chatar\", \"#228B22\", \"#DC143C\")\n  sunburst_data &lt;- sunburst_data %&gt;% add_row(ids = avail_id, labels = paste0(avail, \"&lt;br&gt;(\", total_sp, \" spp)\"), parents = fam_id, values = total_sp, colors = color)\n}\n\n# Extant status (leaf) nodes\nfor(i in seq_len(nrow(species_counts))) {\n  fam &lt;- species_counts$family[i]\n  fam_id &lt;- paste0(\"fam::\", safe_id(fam))\n  avail &lt;- species_counts$availability[i]\n  avail_id &lt;- paste0(fam_id, \"::avail::\", safe_id(avail))\n  extant &lt;- species_counts$is_extant[i]\n  node_id &lt;- paste0(avail_id, \"::\", safe_id(extant))\n  n_sp &lt;- species_counts$n_species[i]\n  color &lt;- ifelse(extant == \"extant\", \"#4169E1\", ifelse(extant == \"extinct\", \"#FFD700\", \"#D3D3D3\"))\n  sunburst_data &lt;- sunburst_data %&gt;% add_row(ids = node_id, labels = paste0(extant, \"&lt;br&gt;(\", n_sp, \" spp)\"), parents = avail_id, values = n_sp, colors = color)\n}\n\n# Sanity checks\nif(any(duplicated(sunburst_data$ids))) stop(\"Duplicate ids detected in sunburst_data; aborting\")\n\n# Create interactive sunburst chart and pass marker colors explicitly\nfig &lt;- plot_ly(\n  type = \"sunburst\",\n  ids = sunburst_data$ids,\n  labels = sunburst_data$labels,\n  parents = sunburst_data$parents,\n  values = sunburst_data$values,\n  branchvalues = \"total\",\n  marker = list(colors = sunburst_data$colors),\n  hovertemplate = \"&lt;b&gt;%{label}&lt;/b&gt;&lt;br&gt;Species: %{value}&lt;br&gt;Percentage: %{percentParent}&lt;extra&gt;&lt;/extra&gt;\",\n  maxdepth = 4,\n  insidetextorientation = 'radial'\n)\nfig &lt;- fig %&gt;% layout(\n  title = list(text = \"Interactive Carnivoran Species Distribution\", font = list(size = 16)), \n  font = list(size = 12), \n  margin = list(t = 50, l = 0, r = 0, b = 0),\n  height = 900,  # Set explicit height to override the default 400px\n  width = NULL   # Let width be responsive\n)\n\n# Make plotly responsive \nfig &lt;- fig %&gt;% config(responsive = TRUE)\n\n# Wrap in a div that uses viewport height to ensure proper display\nhtmltools::div(style = \"width:100%; height:80vh; min-height:900px;\", fig)"
  }
]